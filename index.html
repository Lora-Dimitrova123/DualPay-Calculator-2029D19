<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DualPay</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@600&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">

<style>
body {
  font-family: 'Montserrat', sans-serif;
  background:#fff1f6;
}
h1, button {
  font-family: 'Comfortaa', cursive;
}
</style>
</head>

<body class="min-h-screen flex flex-col items-center justify-between p-4">

<div class="w-full max-w-sm space-y-4">

<h1 class="text-center text-2xl text-pink-500">DualPay</h1>

<!-- INSTALL BUTTON -->
<button id="installBtn"
  class="hidden w-full py-2 rounded-lg bg-green-200 text-white">
  Инсталирай приложението
</button>

<!-- PRICE -->
<div>
  <label class="text-sm font-semibold">Сума за плащане</label>
  <div class="flex gap-2">
    <input id="price" type="number"
      class="flex-1 p-3 rounded-lg bg-yellow-100 outline-none"
      placeholder="0.00">
    <select id="priceCur" class="p-3 rounded-lg">
      <option value="BGN">лв</option>
      <option value="EUR">€</option>
    </select>
  </div>
</div>

<!-- PAID -->
<div>
  <label class="text-sm font-semibold">Платено</label>
  <div class="grid grid-cols-2 gap-2">
    <input id="paidBGN" type="number" class="p-3 rounded-lg" placeholder="лв">
    <input id="paidEUR" type="number" class="p-3 rounded-lg" placeholder="€">
  </div>
</div>

<!-- CALCULATE -->
<button onclick="calculate()"
  class="w-full py-3 rounded-lg bg-green-300 text-white text-lg">
  Изчисли ресто
</button>

<!-- ERROR -->
<div id="error"
  class="hidden text-center text-red-700 bg-red-100 p-3 rounded-lg">
  Недостатъчна сума
</div>

<!-- RESULT -->
<div id="result" class="hidden space-y-2 text-center">
  <div class="flex justify-center gap-2">
    <button onclick="setMode('BGN')" class="px-4 py-1 rounded-full bg-green-200">лв</button>
    <button onclick="setMode('EUR')" class="px-4 py-1 rounded-full bg-green-200">€</button>
  </div>
  <div id="main" class="text-2xl font-semibold"></div>
  <div id="secondary" class="text-sm text-gray-500"></div>
</div>

</div>

<footer class="text-xs text-gray-500 text-center mt-6">
  Курс: 1 EUR = 1.95583 BGN<br>
  © Лора Димитрова
</footer>

<canvas id="icon" width="512" height="512" class="hidden"></canvas>

<script>
const rate = 1.95583;
let mode = 'BGN';

/* CALC */
function calculate(){
  const price = +priceInput.value;
  const paidB = +paidBGN.value;
  const paidE = +paidEUR.value;
  const cur = priceCur.value;

  const priceBGN = cur==='EUR' ? price*rate : price;
  const paidTotal = paidB + paidE*rate;

  if(paidTotal < priceBGN){
    error.classList.remove('hidden');
    result.classList.add('hidden');
    return;
  }

  error.classList.add('hidden');
  result.classList.remove('hidden');

  const bgn = paidTotal - priceBGN;
  const eur = bgn / rate;

  if(mode==='BGN'){
    main.textContent = bgn.toFixed(2)+' лв';
    secondary.textContent = eur.toFixed(2)+' €';
  } else {
    main.textContent = eur.toFixed(2)+' €';
    secondary.textContent = bgn.toFixed(2)+' лв';
  }
}

function setMode(m){ mode=m; calculate(); }

const priceInput = price;
const paidBGN = document.getElementById('paidBGN');
const paidEUR = document.getElementById('paidEUR');
const priceCur = document.getElementById('priceCur');
const error = document.getElementById('error');
const result = document.getElementById('result');
const main = document.getElementById('main');
const secondary = document.getElementById('secondary');

/* ICON */
const ctx = icon.getContext('2d');
ctx.fillStyle='#86efac';
ctx.fillRect(0,0,512,512);
ctx.fillStyle='#fff';
ctx.font='bold 120px Comfortaa';
ctx.textAlign='center';
ctx.fillText('€⇄лв',256,300);
const iconURL = icon.toDataURL();

/* MANIFEST */
const manifest = {
  name:'DualPay',
  short_name:'DualPay',
  start_url:'.',
  display:'standalone',
  background_color:'#fff1f6',
  theme_color:'#86efac',
  icons:[{src:iconURL,sizes:'512x512',type:'image/png'}]
};
const mURL = URL.createObjectURL(new Blob([JSON.stringify(manifest)],{type:'application/json'}));
const ml = document.createElement('link');
ml.rel='manifest'; ml.href=mURL;
document.head.appendChild(ml);

/* SERVICE WORKER */
const sw = new Blob([`
self.addEventListener('install',e=>self.skipWaiting());
self.addEventListener('fetch',()=>{});
`],{type:'text/javascript'});
navigator.serviceWorker.register(URL.createObjectURL(sw));

/* INSTALL PROMPT */
let deferredPrompt;
const installBtn = document.getElementById('installBtn');

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.classList.remove('hidden');
});

installBtn.addEventListener('click', async () => {
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
  installBtn.classList.add('hidden');
});
</script>

</body>
</html>
